<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<!-- This information needs to be the same as that in the package-info.xml. -->
	<id>WWakerFAN:AdditionalPolls</id>
	<version>1.2.2</version>
	
	<file name="$sourcedir/Display.php">
		<operation>
			<search position="replace"><![CDATA[p.question, p.votingLocked, p.hideResults, p.expireTime, p.maxVotes, p.changeVote,]]></search>
		
			<add><![CDATA[p.ID_POLL, p.question, p.votingLocked, p.hideResults, p.expireTime, p.maxVotes, p.changeVote,]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[WHERE p.ID_POLL = $topicinfo[ID_POLL]]]></search>
		
			<add><![CDATA[WHERE p.ID_POLL = $topicinfo[ID_POLL] OR p.ID_TOPIC = $topic]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[LIMIT 1", __FILE__, __LINE__);
		$pollinfo = mysql_fetch_assoc($request);]]></search>
		
			<add><![CDATA[ORDER BY p.question", __FILE__, __LINE__);
		$pollinfo = array();
		while($row = mysql_fetch_assoc($request)) $pollinfo[] = $row;]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[// Get all the options, and calculate the total votes.
		$request = db_query("
			SELECT pc.ID_CHOICE, pc.label, pc.votes, IFNULL(lp.ID_CHOICE, -1) AS votedThis
			FROM {$db_prefix}poll_choices AS pc
				LEFT JOIN {$db_prefix}log_polls AS lp ON (lp.ID_CHOICE = pc.ID_CHOICE AND lp.ID_POLL = $topicinfo[ID_POLL] AND lp.ID_MEMBER = $ID_MEMBER)
			WHERE pc.ID_POLL = $topicinfo[ID_POLL]", __FILE__, __LINE__);
		$pollOptions = array();
		$realtotal = 0;
		$pollinfo['has_voted'] = false;
		while ($row = mysql_fetch_assoc($request))
		{
			censorText($row['label']);
			$pollOptions[$row['ID_CHOICE']] = $row;
			$realtotal += $row['votes'];
			$pollinfo['has_voted'] |= $row['votedThis'] != -1;
		}
		mysql_free_result($request);

		// Set up the basic poll information.
		$context['poll'] = array(
			'id' => $topicinfo['ID_POLL'],
			'image' => 'normal_' . (empty($pollinfo['votingLocked']) ? 'poll' : 'locked_poll'),
			'question' => parse_bbc($pollinfo['question']),
			'total_votes' => $pollinfo['total'],
			'change_vote' => !empty($pollinfo['changeVote']),
			'is_locked' => !empty($pollinfo['votingLocked']),
			'options' => array(),
			'lock' => allowedTo('poll_lock_any') || ($context['user']['started'] && allowedTo('poll_lock_own')),
			'edit' => allowedTo('poll_edit_any') || ($context['user']['started'] && allowedTo('poll_edit_own')),
			'allowed_warning' => $pollinfo['maxVotes'] > 1 ? sprintf($txt['poll_options6'], $pollinfo['maxVotes']) : '',
			'is_expired' => !empty($pollinfo['expireTime']) && $pollinfo['expireTime'] < time(),
			'expire_time' => !empty($pollinfo['expireTime']) ? timeformat($pollinfo['expireTime']) : 0,
			'has_voted' => !empty($pollinfo['has_voted']),
			'starter' => array(
				'id' => $pollinfo['ID_MEMBER'],
				'name' => $row['posterName'],
				'href' => $pollinfo['ID_MEMBER'] == 0 ? '' : $scripturl . '?action=profile;u=' . $pollinfo['ID_MEMBER'],
				'link' => $pollinfo['ID_MEMBER'] == 0 ? $row['posterName'] : '<a href="' . $scripturl . '?action=profile;u=' . $pollinfo['ID_MEMBER'] . '">' . $row['posterName'] . '</a>'
			)
		);]]></search>
		
			<add><![CDATA[foreach($pollinfo as $poll)
		{
			// Get all the options, and calculate the total votes.
			$request = db_query("
				SELECT pc.ID_CHOICE, pc.label, pc.votes, IFNULL(lp.ID_CHOICE, -1) AS votedThis
				FROM {$db_prefix}poll_choices AS pc
					LEFT JOIN {$db_prefix}log_polls AS lp ON (lp.ID_CHOICE = pc.ID_CHOICE AND lp.ID_POLL = $poll[ID_POLL] AND lp.ID_MEMBER = $ID_MEMBER)
				WHERE pc.ID_POLL = $poll[ID_POLL]", __FILE__, __LINE__);
			$pollOptions = array();
			$realtotal = 0;
			$poll['has_voted'] = false;
			while ($row = mysql_fetch_assoc($request))
			{
				censorText($row['label']);
				$pollOptions[$row['ID_CHOICE']] = $row;
				$realtotal += $row['votes'];
				$poll['has_voted'] |= $row['votedThis'] != -1;
			}
			mysql_free_result($request);

			// Set up the basic poll information.
			$context['poll'] = array(
				'id' => $poll['ID_POLL'],
				'image' => 'normal_' . (empty($poll['votingLocked']) ? 'poll' : 'locked_poll'),
				'question' => parse_bbc($poll['question']),
				'total_votes' => $poll['total'],
				'change_vote' => !empty($poll['changeVote']),
				'is_locked' => !empty($poll['votingLocked']),
				'options' => array(),
				'lock' => allowedTo('poll_lock_any') || ($context['user']['started'] && allowedTo('poll_lock_own')),
				'edit' => allowedTo('poll_edit_any') || ($context['user']['started'] && allowedTo('poll_edit_own')),
				'allowed_warning' => $poll['maxVotes'] > 1 ? sprintf($txt['poll_options6'], $poll['maxVotes']) : '',
				'is_expired' => !empty($poll['expireTime']) && $poll['expireTime'] < time(),
				'expire_time' => !empty($poll['expireTime']) ? timeformat($poll['expireTime']) : 0,
				'has_voted' => !empty($poll['has_voted']),
				'starter' => array(
					'id' => $poll['ID_MEMBER'],
					'name' => $row['posterName'],
					'href' => $poll['ID_MEMBER'] == 0 ? '' : $scripturl . '?action=profile;u=' . $poll['ID_MEMBER'],
					'link' => $poll['ID_MEMBER'] == 0 ? $row['posterName'] : '<a href="' . $scripturl . '?action=profile;u=' . $poll['ID_MEMBER'] . '">' . $row['posterName'] . '</a>'
				)
			);]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[$context['allow_vote'] = !$context['poll']['is_expired'] && !$user_info['is_guest'] && empty($pollinfo['votingLocked']) && allowedTo('poll_vote') && !$context['poll']['has_voted'];]]></search>
		
			<add><![CDATA[$context['poll']['allow_vote'] = !$context['poll']['is_expired'] && !$user_info['is_guest'] && empty($poll['votingLocked']) && allowedTo('poll_vote') && !$context['poll']['has_voted'];]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[$context['allow_poll_view'] = allowedTo('moderate_board') || $pollinfo['hideResults'] == 0 || ($pollinfo['hideResults'] == 1 && $context['poll']['has_voted']) || $context['poll']['is_expired'];]]></search>
		
			<add><![CDATA[$context['poll']['allow_poll_view'] = allowedTo('moderate_board') || $poll['hideResults'] == 0 || ($poll['hideResults'] == 1 && $context['poll']['has_voted']) || $context['poll']['is_expired'];]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[$context['poll']['show_results'] = $context['allow_poll_view'] && isset($_REQUEST['viewResults']);]]></search>
		
			<add><![CDATA[$context['poll']['show_results'] = $context['poll']['allow_poll_view'] && isset($_REQUEST['viewResults']) && $poll['ID_POLL'] == $_REQUEST['poll'];]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[$context['allow_change_vote'] = !$context['poll']['is_expired'] && !$user_info['is_guest'] && empty($pollinfo['votingLocked']) && allowedTo('poll_vote') && $context['poll']['has_voted'] && $context['poll']['change_vote'];]]></search>
		
			<add><![CDATA[$context['poll']['allow_change_vote'] = !$context['poll']['is_expired'] && !$user_info['is_guest'] && empty($poll['votingLocked']) && allowedTo('poll_vote') && $context['poll']['has_voted'] && $context['poll']['change_vote'];]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA['vote_button' => '<input type="' . ($pollinfo['maxVotes'] > 1 ? 'checkbox' : 'radio') . '" name="options[]" id="options-' . $i . '" value="' . $i . '" class="check" />']]></search>
		
			<add><![CDATA['vote_button' => '<input type="' . ($poll['maxVotes'] > 1 ? 'checkbox' : 'radio') . '" name="options[]" id="options-' . $i . '" value="' . $i . '" class="check" />']]></add>
		</operation>
		
		<operation>
			<search position="after"><![CDATA[
	}

	// Calculate the fastest way to get the messages!]]></search>
		
			<add><![CDATA[
			$context['polls'][] = $context['poll'];
			unset($context['poll']);
		}]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[$context['can_add_poll'] &= $modSettings['pollMode'] == '1' && $topicinfo['ID_POLL'] <= 0;]]></search>
		
			<add><![CDATA[$context['can_add_poll'] &= $modSettings['pollMode'] == '1';]]></add>
		</operation>
	</file>
	
	<file name="$sourcedir/Poll.php">
		<operation>
			<search position="before"><![CDATA[global $topic, $txt, $db_prefix, $ID_MEMBER, $user_info;

]]></search>
		
			<add><![CDATA[$poll = !empty($_REQUEST['poll']) ? (int)$_REQUEST['poll'] : 0;
	
]]></add>
		</operation>
	
		<operation>
			<search position="replace"><![CDATA[FROM ({$db_prefix}polls AS p, {$db_prefix}topics AS t)
			LEFT JOIN {$db_prefix}log_polls AS lp ON (p.ID_POLL = lp.ID_POLL AND lp.ID_MEMBER = $ID_MEMBER)
		WHERE p.ID_POLL = t.ID_POLL
			AND t.ID_TOPIC = $topic]]></search>
		
			<add><![CDATA[FROM {$db_prefix}topics AS t
			LEFT JOIN {$db_prefix}polls AS p ON (p.ID_TOPIC = t.ID_TOPIC) LEFT JOIN {$db_prefix}log_polls AS lp ON (p.ID_POLL = lp.ID_POLL AND lp.ID_MEMBER = $ID_MEMBER)
		WHERE p.ID_TOPIC = $topic AND (p.ID_POLL = $poll OR p.ID_POLL = t.ID_POLL)
		ORDER BY p.ID_POLL DESC]]></add>
		</operation>
		
		<operation>
			<search position="before"><![CDATA[global $topic, $ID_MEMBER, $db_prefix, $user_info;

]]></search>
		
			<add><![CDATA[$poll = !empty($_REQUEST['poll']) ? (int)$_REQUEST['poll'] : 0;
	
]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[SELECT t.ID_MEMBER_STARTED, t.ID_POLL, p.votingLocked
		FROM ({$db_prefix}topics AS t, {$db_prefix}polls AS p)
		WHERE t.ID_TOPIC = $topic
			AND p.ID_POLL = t.ID_POLL]]></search>
		
			<add><![CDATA[SELECT t.ID_MEMBER_STARTED, p.ID_POLL, p.votingLocked
		FROM {$db_prefix}topics AS t
			LEFT JOIN {$db_prefix}polls AS p ON (p.ID_TOPIC = t.ID_TOPIC)
		WHERE p.ID_TOPIC = $topic AND (p.ID_POLL = $poll OR p.ID_POLL = t.ID_POLL)
		ORDER BY p.ID_POLL DESC]]></add>
		</operation>
		
		<operation>
			<search position="before"><![CDATA[global $user_info, $context, $topic, $func;

]]></search>
		
			<add><![CDATA[$poll = !empty($_REQUEST['poll']) ? (int)$_REQUEST['poll'] : 0;
	
]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[// Check if a poll currently exists on this topic, and get the id, question and starter.
	$request = db_query("
		SELECT
			t.ID_MEMBER_STARTED, p.ID_POLL, p.question, p.hideResults, p.expireTime, p.maxVotes, p.changeVote,
			p.ID_MEMBER AS pollStarter
		FROM {$db_prefix}topics AS t
			LEFT JOIN {$db_prefix}polls AS p ON (p.ID_POLL = t.ID_POLL)
		WHERE t.ID_TOPIC = $topic
		LIMIT 1", __FILE__, __LINE__);]]></search>
		
			<add><![CDATA[if($context['is_edit'])
	{
		// Check if a poll currently exists on this topic, and get the id, question and starter.
		$request = db_query("
			SELECT
				t.ID_MEMBER_STARTED, p.ID_POLL, p.question, p.hideResults, p.expireTime, p.maxVotes, p.changeVote,
				p.ID_MEMBER AS pollStarter
			FROM {$db_prefix}topics AS t
				LEFT JOIN {$db_prefix}polls AS p ON (p.ID_TOPIC = t.ID_TOPIC)
			WHERE p.ID_TOPIC = $topic AND (p.ID_POLL = $poll OR p.ID_POLL = t.ID_POLL)
			ORDER BY p.ID_POLL DESC
			LIMIT 1
		", __FILE__, __LINE__);
	}
	else
	{
		// Check if a poll currently exists on this topic, and get the id, question and starter.
		$request = db_query("
		SELECT
			t.ID_MEMBER_STARTED, p.ID_POLL, p.question, p.hideResults, p.expireTime, p.maxVotes, p.changeVote,
			p.ID_MEMBER AS pollStarter
		FROM {$db_prefix}topics AS t
			LEFT JOIN {$db_prefix}polls AS p ON (p.ID_POLL = t.ID_POLL)
		WHERE t.ID_TOPIC = $topic
		LIMIT 1", __FILE__, __LINE__);
	}]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[// If we are adding a new poll - make sure that there isn't already a poll there.
	if (!$context['is_edit'] && !empty($pollinfo['ID_POLL']))
		fatal_lang_error('poll_already_exists');]]></search>
		
			<add><![CDATA[/* REMEMBER TO RE-ADD CODE HERE 289347 */]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[elseif ($context['is_edit'] && empty($pollinfo['ID_POLL']))]]></search>
		
			<add><![CDATA[if ($context['is_edit'] && empty($pollinfo['ID_POLL']))]]></add>
		</operation>
		
		<operation>
			<search position="before"><![CDATA[global $modSettings, $user_info, $func;

]]></search>
		
			<add><![CDATA[	$poll = !empty($_REQUEST['poll']) ? (int)$_REQUEST['poll'] : 0;
	
]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[// Get the starter and the poll's ID - if it's an edit.
	$request = db_query("
		SELECT t.ID_MEMBER_STARTED, t.ID_POLL, p.ID_MEMBER AS pollStarter
		FROM {$db_prefix}topics AS t
			LEFT JOIN {$db_prefix}polls AS p ON (p.ID_POLL = t.ID_POLL)
		WHERE t.ID_TOPIC = $topic
		LIMIT 1", __FILE__, __LINE__);]]></search>
		
			<add><![CDATA[if($isEdit)
	{
		// Check if a poll currently exists on this topic, and get the id, question and starter.
		$request = db_query("
			SELECT
				t.ID_MEMBER_STARTED, p.ID_POLL, p.question, p.hideResults, p.expireTime, p.maxVotes, p.changeVote,
				p.ID_MEMBER AS pollStarter
			FROM {$db_prefix}topics AS t
				LEFT JOIN {$db_prefix}polls AS p ON (p.ID_TOPIC = t.ID_TOPIC)
			WHERE p.ID_TOPIC = $topic AND (p.ID_POLL = $poll OR p.ID_POLL = t.ID_POLL)
			ORDER BY p.ID_POLL DESC
			LIMIT 1
		", __FILE__, __LINE__);
	}
	else
	{
		// Check if a poll currently exists on this topic, and get the id, question and starter.
		$request = db_query("
			SELECT
				t.ID_MEMBER_STARTED
			FROM {$db_prefix}topics AS t
			WHERE t.ID_TOPIC = $topic
			LIMIT 1
		", __FILE__, __LINE__);
	}]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[// Check their adding/editing is valid.
	if (!$isEdit && !empty($bcinfo['ID_POLL']))
		fatal_lang_error('poll_already_exists');]]></search>
		
			<add><![CDATA[/* REMEMBER TO RE-ADD CODE HERE 892734 */]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[elseif ($isEdit && empty($bcinfo['ID_POLL']))]]></search>
		
			<add><![CDATA[if ($isEdit && empty($bcinfo['ID_POLL']))]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[(question, hideResults, maxVotes, expireTime, ID_MEMBER, posterName, changeVote)
			VALUES (SUBSTRING('$_POST[question]', 1, 255), $_POST[poll_hide], $_POST[poll_max_votes], $_POST[poll_expire], $ID_MEMBER, SUBSTRING('$user_info[username]', 1, 255), $_POST[poll_change_vote])", __FILE__, __LINE__);]]></search>
		
			<add><![CDATA[(ID_TOPIC, question, hideResults, maxVotes, expireTime, ID_MEMBER, posterName, changeVote)
			VALUES ($topic, SUBSTRING('$_POST[question]', 1, 255), $_POST[poll_hide], $_POST[poll_max_votes], $_POST[poll_expire], $ID_MEMBER, SUBSTRING('$user_info[username]', 1, 255), $_POST[poll_change_vote])", __FILE__, __LINE__);]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[// Link the poll to the topic
		db_query("
			UPDATE {$db_prefix}topics
			SET ID_POLL = $bcinfo[ID_POLL]
			WHERE ID_TOPIC = $topic
			LIMIT 1", __FILE__, __LINE__);]]></search>
		
			<add><![CDATA[// Link the poll to the topic
		db_query("
			UPDATE {$db_prefix}topics
			SET ID_POLL = $bcinfo[ID_POLL]
			WHERE ID_TOPIC = $topic AND ID_POLL = 0
			LIMIT 1", __FILE__, __LINE__);]]></add>
		</operation>
		
		<operation>
			<search position="before"><![CDATA[global $topic, $db_prefix, $user_info, $ID_MEMBER;

]]></search>
		
			<add><![CDATA[	$poll = !empty($_REQUEST['poll']) ? (int)$_REQUEST['poll'] : 0;
	
]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[FROM ({$db_prefix}topics AS t, {$db_prefix}polls AS p)
			WHERE t.ID_TOPIC = $topic
				AND p.ID_POLL = t.ID_POLL]]></search>
		
			<add><![CDATA[FROM {$db_prefix}topics AS t
				LEFT JOIN {$db_prefix}polls AS p ON (p.ID_TOPIC = t.ID_TOPIC)
			WHERE p.ID_TOPIC = $topic AND (p.ID_POLL = $poll OR p.ID_POLL = t.ID_POLL)
			ORDER BY p.ID_POLL DESC]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[SELECT ID_POLL
		FROM {$db_prefix}topics
		WHERE ID_TOPIC = $topic]]></search>
		
			<add><![CDATA[SELECT p.ID_POLL
		FROM {$db_prefix}topics AS t
			LEFT JOIN {$db_prefix}polls AS p ON (p.ID_TOPIC = t.ID_TOPIC)
		WHERE p.ID_TOPIC = $topic AND (p.ID_POLL = $poll OR p.ID_POLL = t.ID_POLL)
		ORDER BY p.ID_POLL DESC]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[// Finally set the topic poll ID back to 0!
	db_query("
		UPDATE {$db_prefix}topics
		SET ID_POLL = 0
		WHERE ID_TOPIC = $topic
		LIMIT 1", __FILE__, __LINE__);]]></search>
		
			<add><![CDATA[// Finally set the topic poll ID back to 0!
	db_query("
		UPDATE {$db_prefix}topics
		SET ID_POLL = 0
		WHERE ID_TOPIC = $topic AND ID_POLL = $pollID
		LIMIT 1", __FILE__, __LINE__);]]></add>
		</operation>
		
		<operation>
			<search position="after"><![CDATA[// Take the moderator back to the topic.
	redirectexit('topic=' . $topic . '.' . $_REQUEST['start']);
}

?>]]></search>
		
			<add><![CDATA[	if(mysql_affected_rows() > 0)
	{
		$request = db_query("
			SELECT ID_POLL
			FROM {$db_prefix}polls
			WHERE ID_TOPIC = $topic
			LIMIT 1", __FILE__, __LINE__);			
		
		if(mysql_num_rows($request) > 0)
		{
			list($pollID) = mysql_fetch_row($request);
			
			mysql_free_result($request);
			
			db_query("
				UPDATE {$db_prefix}topics
				SET ID_POLL = $pollID
				WHERE ID_TOPIC = $topic
				LIMIT 1", __FILE__, __LINE__);
		}
	}
	
]]></add>
		</operation>
	</file>
	
	<file name="$sourcedir/RemoveTopic.php">
		<operation>
			<search position="replace"><![CDATA[// Remove Polls.
	$request = db_query("
		SELECT ID_POLL
		FROM {$db_prefix}topics
		WHERE ID_TOPIC $condition
			AND ID_POLL > 0
		LIMIT " . count($topics), __FILE__, __LINE__);]]></search>
		
			<add><![CDATA[// Remove Polls.
	$request = db_query("
		SELECT ID_POLL
		FROM {$db_prefix}polls
		WHERE ID_TOPIC $condition
	", __FILE__, __LINE__);]]></add>
		</operation>
	</file>
	
	<file name="$sourcedir/SplitTopics.php">
		<operation>
			<search position="replace"><![CDATA[if ($row['ID_POLL'] > 0)
			$polls[] = $row['ID_POLL'];]]></search>
		
			<add><![CDATA[if ($row['ID_POLL'] > 0)
		{
			$polls[] = $row['ID_POLL'];
			
			$request2 = db_query("
				SELECT ID_POLL
				FROM {$db_prefix}polls
				WHERE ID_TOPIC = $row[ID_TOPIC] AND ID_POLL != $row[ID_POLL]
			", __FILE__, __LINE__);
			
			while ($row2 = mysql_fetch_assoc($request2)) $polls[] = $row2['ID_POLL'];
			mysql_free_result($request2);
		
		}]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[SELECT t.ID_TOPIC, t.ID_POLL, m.subject, p.question
				FROM ({$db_prefix}polls AS p, {$db_prefix}topics AS t, {$db_prefix}messages AS m)]]></search>
		
			<add><![CDATA[SELECT t.ID_TOPIC, p.ID_POLL, m.subject, p.question
				FROM ({$db_prefix}polls AS p LEFT JOIN {$db_prefix}topics AS t ON p.ID_TOPIC = t.ID_TOPIC LEFT JOIN {$db_prefix}messages AS m ON t.ID_FIRST_MSG = m.ID_MSG)]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[AND t.ID_POLL = p.ID_POLL
					AND m.ID_MSG = t.ID_FIRST_MSG]]></search>
		
			<add><![CDATA[" . /* REMEMBER TO RE-ADD CODE HERE 763248 */"]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[$target_poll = count($polls) > 1 ? (int) $_POST['poll'] : (count($polls) == 1 ? $polls[0] : 0);
	if ($target_poll > 0 && !in_array($target_poll, $polls))
		fatal_lang_error(1, false);
	$deleted_polls = empty($target_poll) ? $polls : array_diff($polls, array($target_poll));]]></search>
		
			<add><![CDATA[$target_poll = array();
	if(!empty($_POST['poll']))
	{
		foreach($_POST['poll'] as $poll)
		{
			$poll = (int) $poll;
			if ($poll > 0 && !in_array($poll, $polls))
				fatal_lang_error(1, false);
			$target_poll[] = $poll;
		}
	}
	
	$deleted_polls = array_diff($polls, $target_poll);]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[	// Grab the response prefix (like 'Re: ') in the default forum language.]]></search>
		
			<add><![CDATA[	
	foreach($target_poll as $poll)
	{
		db_query("
			UPDATE {$db_prefix}polls
			SET ID_TOPIC = $ID_TOPIC
			WHERE ID_POLL = $poll
			LIMIT 1", __FILE__, __LINE__);
	}
	
]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[ID_POLL = $target_poll,]]></search>
		
			<add><![CDATA[ID_POLL = " . (empty($target_poll) ? "0" : min($target_poll)) . ",]]></add>
		</operation>
	</file>
	
	<file name="$themedir/SplitTopics.template.php">
		<operation>
			<search position="replace"><![CDATA[<input type="radio" name="poll" value="' . $poll['id'] . '"' . ($poll['selected'] ? ' checked="checked"' : '') . ' class="check" /> ' . $poll['question'] . ' (' . $txt[118] . ': <a href="' . $scripturl . '?topic=' . $poll['topic']['id'] . '.0" target="_blank">' . $poll['topic']['subject'] . '</a>)]]></search>
		
			<add><![CDATA[<input type="checkbox" name="poll[]" value="' . $poll['id'] . '"' . ($poll['selected'] ? ' checked="checked"' : '') . ' class="check" /> ' . $poll['question'] . ' (' . $txt[118] . ': <a href="' . $scripturl . '?topic=' . $poll['topic']['id'] . '.0" target="_blank">' . $poll['topic']['subject'] . '</a>)]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[						<tr>
							<td>
								<input type="radio" name="poll" value="-1" class="check" /> (' . $txt['merge_no_poll'] . ')
							</td>
						</tr>]]></search>
		
			<add><![CDATA[', /* REMEMBER TO RE-ADD CODE HERE 2309478 */']]></add>
		</operation>
	</file>
	
	<file name="$themedir/Display.template.php">
		<operation>
			<search position="replace"><![CDATA[// Is this topic also a poll?
	if ($context['is_poll'])
	{
		echo '
<table cellpadding="3" cellspacing="0" border="0" width="100%" class="tborder" style="padding-top: 0; margin-bottom: 2ex;">
	<tr>
		<td class="titlebg" colspan="2" valign="middle" style="padding-left: 6px;">
			<img src="', $settings['images_url'], '/topic/', $context['poll']['is_locked'] ? 'normal_poll_locked' : 'normal_poll', '.gif" alt="" align="bottom" /> ', $txt['smf43'], '
		</td>
	</tr>
	<tr>
		<td width="5%" valign="top" class="windowbg"><b>', $txt['smf21'], ':</b></td>
		<td class="windowbg">
			', $context['poll']['question'];
		if (!empty($context['poll']['expire_time']))
			echo '
					&nbsp;(', ($context['poll']['is_expired'] ? $txt['poll_expired_on'] : $txt['poll_expires_on']), ': ', $context['poll']['expire_time'], ')';

		// Are they not allowed to vote but allowed to view the options?
		if ($context['poll']['show_results'] || !$context['allow_vote'])
		{
			echo '
			<table>
				<tr>
					<td style="padding-top: 2ex;">
						<table border="0" cellpadding="0" cellspacing="0">';

				// Show each option with its corresponding percentage bar.
			foreach ($context['poll']['options'] as $option)
				echo '
							<tr>
								<td style="padding-right: 2ex;', $option['voted_this'] ? 'font-weight: bold;' : '', '">', $option['option'], '</td>', $context['allow_poll_view'] ? '
								<td nowrap="nowrap">' . $option['bar'] . ' ' . $option['votes'] . ' (' . $option['percent'] . '%)</td>' : '', '
							</tr>';

			echo '
						</table>
					</td>
					<td valign="bottom" style="padding-left: 15px;">';

			// If they are allowed to revote - show them a link!
			if ($context['allow_change_vote'])
				echo '
					<a href="', $scripturl, '?action=vote;topic=', $context['current_topic'], '.', $context['start'], ';poll=', $context['poll']['id'], ';sesc=', $context['session_id'], '">', $txt['poll_change_vote'], '</a><br />';

			// If we're viewing the results... maybe we want to go back and vote?
			if ($context['poll']['show_results'] && $context['allow_vote'])
				echo '
						<a href="', $scripturl, '?topic=', $context['current_topic'], '.', $context['start'], '">', $txt['poll_return_vote'], '</a><br />';

			// If they're allowed to lock the poll, show a link!
			if ($context['poll']['lock'])
				echo '
						<a href="', $scripturl, '?action=lockVoting;topic=', $context['current_topic'], '.', $context['start'], ';sesc=', $context['session_id'], '">', !$context['poll']['is_locked'] ? $txt['smf30'] : $txt['smf30b'], '</a><br />';

			// If they're allowed to edit the poll... guess what... show a link!
			if ($context['poll']['edit'])
				echo '
						<a href="', $scripturl, '?action=editpoll;topic=', $context['current_topic'], '.', $context['start'], '">', $txt['smf39'], '</a>';

			echo '
					</td>
				</tr>', $context['allow_poll_view'] ? '
				<tr>
					<td colspan="2"><b>' . $txt['smf24'] . ': ' . $context['poll']['total_votes'] . '</b></td>
				</tr>' : '', '
			</table><br />';
		}
		// They are allowed to vote! Go to it!
		else
		{
			echo '
			<form action="', $scripturl, '?action=vote;topic=', $context['current_topic'], '.', $context['start'], ';poll=', $context['poll']['id'], '" method="post" accept-charset="', $context['character_set'], '" style="margin: 0px;">
				<table>
					<tr>
						<td colspan="2">';

			// Show a warning if they are allowed more than one option.
			if ($context['poll']['allowed_warning'])
				echo '
							', $context['poll']['allowed_warning'], '
						</td>
					</tr><tr>
						<td>';

			// Show each option with its button - a radio likely.
			foreach ($context['poll']['options'] as $option)
				echo '
							', $option['vote_button'], ' ', $option['option'], '<br />';

			echo '
						</td>
						<td valign="bottom" style="padding-left: 15px;">';

			// Allowed to view the results? (without voting!)
			if ($context['allow_poll_view'])
				echo '
							<a href="', $scripturl, '?topic=', $context['current_topic'], '.', $context['start'], ';viewResults">', $txt['smf29'], '</a><br />';

			// Show a link for locking the poll as well...
			if ($context['poll']['lock'])
				echo '
							<a href="', $scripturl, '?action=lockVoting;topic=', $context['current_topic'], '.', $context['start'], ';sesc=', $context['session_id'], '">', (!$context['poll']['is_locked'] ? $txt['smf30'] : $txt['smf30b']), '</a><br />';

			// Want to edit it? Click right here......
			if ($context['poll']['edit'])
				echo '
							<a href="', $scripturl, '?action=editpoll;topic=', $context['current_topic'], '.', $context['start'], '">', $txt['smf39'], '</a>';

				echo '
						</td>
					</tr><tr>
						<td colspan="2"><input type="submit" value="', $txt['smf23'], '" /></td>
					</tr>
				</table>
				<input type="hidden" name="sc" value="', $context['session_id'], '" />
			</form>';
		}

		echo '
		</td>
	</tr>
</table>';
	}]]></search>
		
			<add><![CDATA[// Is this topic also a poll?
	if ($context['is_poll'])
	{
		echo '
	<table cellpadding="3" cellspacing="0" border="0" width="100%" class="tborder" style="padding-top: 0; margin-bottom: 2ex;">
		<tr>
			<td class="titlebg" colspan="2" valign="middle" style="padding-left: 6px;">
				<img src="', $settings['images_url'], '/topic/normal_poll.gif" alt="" align="bottom" /> ', $txt['smf43'], '
			</td>
		</tr>';
	
		foreach($context['polls'] as $context['poll'])
		{
			$context['allow_vote'] = $context['poll']['allow_vote'];
			$context['allow_poll_view'] = $context['poll']['allow_poll_view'];
			$context['allow_change_vote'] = $context['poll']['allow_change_vote'];
		
			echo '
	<tr>
		<td width="5%" valign="top" class="windowbg"><table cellpadding="0" cellspacing="0"><tr><td><img src="', $settings['images_url'], '/topic/', $context['poll']['is_locked'] ? 'normal_poll_locked' : 'normal_poll', '.gif" alt="" /></td><td><b>', $txt['smf21'], ':</b></td></tr></table></td>
		<td class="windowbg">
			', $context['poll']['question'];
		if (!empty($context['poll']['expire_time']))
			echo '
					&nbsp;(', ($context['poll']['is_expired'] ? $txt['poll_expired_on'] : $txt['poll_expires_on']), ': ', $context['poll']['expire_time'], ')';

		// Are they not allowed to vote but allowed to view the options?
		if ($context['poll']['show_results'] || !$context['allow_vote'])
		{
			echo '
			<table>
				<tr>
					<td style="padding-top: 2ex;">
						<table border="0" cellpadding="0" cellspacing="0">';

				// Show each option with its corresponding percentage bar.
			foreach ($context['poll']['options'] as $option)
				echo '
							<tr>
								<td style="padding-right: 2ex;', $option['voted_this'] ? 'font-weight: bold;' : '', '">', $option['option'], '</td>', $context['allow_poll_view'] ? '
								<td nowrap="nowrap">' . $option['bar'] . ' ' . $option['votes'] . ' (' . $option['percent'] . '%)</td>' : '', '
							</tr>';

			echo '
						</table>
					</td>
					<td valign="bottom" style="padding-left: 15px;">';

			// If they are allowed to revote - show them a link!
			if ($context['allow_change_vote'])
				echo '
					<a href="', $scripturl, '?action=vote;topic=', $context['current_topic'], '.', $context['start'], ';poll=', $context['poll']['id'], ';sesc=', $context['session_id'], '">', $txt['poll_change_vote'], '</a><br />';

			// If we're viewing the results... maybe we want to go back and vote?
			if ($context['poll']['show_results'] && $context['allow_vote'])
				echo '
						<a href="', $scripturl, '?topic=', $context['current_topic'], '.', $context['start'], ';poll=', $context['poll']['id'], '">', $txt['poll_return_vote'], '</a><br />';

			// If they're allowed to lock the poll, show a link!
			if ($context['poll']['lock'])
				echo '
						<a href="', $scripturl, '?action=lockVoting;topic=', $context['current_topic'], '.', $context['start'], ';poll=', $context['poll']['id'], ';sesc=', $context['session_id'], '">', !$context['poll']['is_locked'] ? $txt['smf30'] : $txt['smf30b'], '</a><br />';

			// If they're allowed to edit the poll... guess what... show a link!
			if ($context['poll']['edit'])
				echo '
						<a href="', $scripturl, '?action=editpoll;topic=', $context['current_topic'], '.', $context['start'], ';poll=', $context['poll']['id'], '">', $txt['smf39'], '</a><br />';

			// If they're allowed to remove the poll... guess what... show a link!
			if ($context['can_remove_poll'])
				echo '
						<a href="', $scripturl, '?action=removepoll;topic=', $context['current_topic'], '.', $context['start'], ';sesc=' . $context['session_id'], ';poll=', $context['poll']['id'], '" onclick="return confirm(\'' . $txt['poll_remove_warn'] . '\');">', $txt['poll_remove'], '</a>';

			echo '
					</td>
				</tr>', $context['allow_poll_view'] ? '
				<tr>
					<td colspan="2"><b>' . $txt['smf24'] . ': ' . $context['poll']['total_votes'] . '</b></td>
				</tr>' : '', '
			</table><br />';
		}
		// They are allowed to vote! Go to it!
		else
		{
			echo '
			<form action="', $scripturl, '?action=vote;topic=', $context['current_topic'], '.', $context['start'], ';poll=', $context['poll']['id'], '" method="post" accept-charset="', $context['character_set'], '" style="margin: 0px;">
				<table>
					<tr>
						<td colspan="2">';

			// Show a warning if they are allowed more than one option.
			if ($context['poll']['allowed_warning'])
				echo '
							', $context['poll']['allowed_warning'], '
						</td>
					</tr><tr>
						<td>';

			// Show each option with its button - a radio likely.
			foreach ($context['poll']['options'] as $option)
				echo '
							', $option['vote_button'], ' ', $option['option'], '<br />';

			echo '
						</td>
						<td valign="bottom" style="padding-left: 15px;">';

			// Allowed to view the results? (without voting!)
			if ($context['allow_poll_view'])
				echo '
							<a href="', $scripturl, '?topic=', $context['current_topic'], '.', $context['start'], ';poll=', $context['poll']['id'], ';viewResults">', $txt['smf29'], '</a><br />';

			// Show a link for locking the poll as well...
			if ($context['poll']['lock'])
				echo '
							<a href="', $scripturl, '?action=lockVoting;topic=', $context['current_topic'], '.', $context['start'], ';poll=', $context['poll']['id'], ';sesc=', $context['session_id'], '">', (!$context['poll']['is_locked'] ? $txt['smf30'] : $txt['smf30b']), '</a><br />';

			// Want to edit it? Click right here......
			if ($context['poll']['edit'])
				echo '
							<a href="', $scripturl, '?action=editpoll;topic=', $context['current_topic'], '.', $context['start'], ';poll=', $context['poll']['id'], '">', $txt['smf39'], '</a><br />';

			// If they're allowed to remove the poll... guess what... show a link!
			if ($context['can_remove_poll'])
				echo '
						<a href="', $scripturl, '?action=removepoll;topic=', $context['current_topic'], '.', $context['start'], ';sesc=' . $context['session_id'], ';poll=', $context['poll']['id'], '" onclick="return confirm(\'' . $txt['poll_remove_warn'] . '\');">', $txt['poll_remove'], '</a>';

						
				echo '
						</td>
					</tr><tr>
						<td colspan="2"><input type="submit" value="', $txt['smf23'], '" /></td>
					</tr>
				</table>
				<input type="hidden" name="sc" value="', $context['session_id'], '" />
			</form>';
		}

			echo '
			</td>
		</tr>';
		}
		unset($context['poll']);
		unset($context['allow_vote']);
		unset($context['allow_poll_view']);
		unset($context['allow_change_vote']);
		
		echo '
	</table>';
	}]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA['remove_poll' => array('test' => 'can_remove_poll', 'text' => 'poll_remove', 'image' => 'admin_remove_poll.gif', 'lang' => true, 'custom' => 'onclick="return confirm(\'' . $txt['poll_remove_warn'] . '\');"', 'url' => $scripturl . '?action=removepoll;topic=' . $context['current_topic'] . '.' . $context['start'] . ';sesc=' . $context['session_id']),]]></search>
		
			<add><![CDATA[//'remove_poll' => array('test' => 'can_remove_poll', 'text' => 'poll_remove', 'image' => 'admin_remove_poll.gif', 'lang' => true, 'custom' => 'onclick="return confirm(\'' . $txt['poll_remove_warn'] . '\');"', 'url' => $scripturl . '?action=removepoll;topic=' . $context['current_topic'] . '.' . $context['start'] . ';sesc=' . $context['session_id']),]]></add>
		</operation>
	</file>
	
	<file name="$sourcedir/Subs-Post.php">
		<operation>
			<search position="after"><![CDATA[		// Fix the message with the topic.
		db_query("
			UPDATE {$db_prefix}messages
			SET ID_TOPIC = $topicOptions[id]
			WHERE ID_MSG = $msgOptions[id]
			LIMIT 1", __FILE__, __LINE__);]]></search>
		
			<add><![CDATA[		// Fix the poll with the topic.
		if($topicOptions['poll'] !== NULL)
			db_query("
				UPDATE {$db_prefix}polls
				SET ID_TOPIC = $topicOptions[id]
				WHERE ID_POLL = $topicOptions[poll]
				LIMIT 1", __FILE__, __LINE__);
]]></add>
		</operation>
	</file>
</modification>
